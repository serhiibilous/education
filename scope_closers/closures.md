## Замыкание (Closures)

# Определение

**Замыкание** — это когда функция умеет запоминать 
и имеет доступ к лексической области видимости даже тогда, 
когда эта функция выполняется вне своей лексической области видимости.

```js
function foo() {
	var a = 2;

	function bar() {
		console.log( a );
	}

	return bar;
}

var baz = foo();

baz(); // 2 -- Вот это и есть замыкание!
```

Благодаря тому, где она была объявлена, 
у `bar()` есть замыкание лексической области видимости на внутреннею область видимости `foo(),` 
которая удерживает область видимости для `bar()`, чтобы ссылаться на нее позднее.

**`bar()` все еще содержит ссылку на эту область видимости и эта ссылка называется замыканием.**

## Циклы + замыкание

Самый распространенный канонический пример, 
используемый для иллюстрации замыкания, приводят с использованием скромного цикла `for`.

```js
for (var i=1; i<=5; i++) {
	setTimeout( function timer(){
		console.log( i );
	}, i*1000 );
}
```

**Результат:** нам выведется число `6` пять раз.

Нам не хватает того, что мы пытаемся предполагать, что каждая итерация цикла "захватывает" 
свою собственную копию `i` во время выполнения итерации. 
Но, тем путем, которым работает область видимости, все 5 этих функций, 
хотя они и определяются отдельно в каждой итерации цикла, 
все они замыкаются на одну и ту же **глобальную разделяемую область видимости**, в которой, 
фактически, только одна переменная `i`.

Как это исправить (3 способа):

1. Завернуть таймаут в IIFE функцию, которая создает свою собственную область видимости, 
   и создать внутри нне еще одну переменную значение которой будет `i`.
   
    ```js
    for (var i=1; i<=5; i++) {
        (function(){
            var j = i;
            setTimeout( function timer(){
                console.log( j );
            }, j*1000 );
        })();
    }
    ```

2. Прокинуть значение переменной счетчика как параметр в IIFE функцию.

    ```js
    for (var i=1; i<=5; i++) {
        (function(j){
            setTimeout( function timer(){
                console.log( j );
            }, j*1000 );
        })( j );
    }
    ```
   
3. Использовать блочную область видимости, с помощью объявления переменной через `let`.

    ```js
    for (let i=1; i<=5; i++) {
        setTimeout( function timer(){
            console.log( i );
        }, i*1000 );
    }
    ```